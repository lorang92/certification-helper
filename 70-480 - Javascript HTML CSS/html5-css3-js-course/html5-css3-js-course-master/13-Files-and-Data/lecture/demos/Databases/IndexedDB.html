<!DOCTYPE html>
<html>
<head>
	<title>IndexedDB Example</title>

	<style>
		body {
			font-family: 'Segoe UI Light', 'Verdana', 'Sans serif';
		}
		label {
			width: 120px;
			display: inline-block;
			margin-bottom: 10px;
		}

		.productDescription {
			width: 200px;
			display: inline-block;
		}
		
		a {
			margin-left: 20px;
		}
	</style>
	
	<script>

		var myDataStore = {};
		var count = 0;
		
		myDataStore.indexedDB = {};
		myDataStore.indexedDB.db = null;

		myDataStore.indexedDB.open = function() {

			var version = 1;
			var request = indexedDB.open('productsDB', version);

			// We can only create Object stores in a versionchange transaction.
			request.onupgradeneeded = function(e) {
				var db = e.target.result;

				// A versionchange transaction is started automatically.
				e.target.transaction.onerror = myDataStore.indexedDB.onerror;

				// Delete the 'product' object store if it already exists.
				if (db.objectStoreNames.contains('product')) {
					db.deleteObjectStore('product');
				}

				// Create the 'product' object store, and specify the 'id' property as the key property.
				db.createObjectStore('product', {keyPath: 'id'});
			};

			request.onsuccess = function(e) {
				myDataStore.indexedDB.db = e.target.result;
				myDataStore.indexedDB.getAllProducts();
			};

			request.onerror = myDataStore.indexedDB.onerror;
		};

		myDataStore.indexedDB.addProduct = function(id, name, price) {
			
			var db = myDataStore.indexedDB.db;
			var trans = db.transaction(['product'], 'readwrite');
			var store = trans.objectStore('product');
			
			var request = store.put({
				id: id,
				name: name,
				price: price
			});

			request.onsuccess = function(e) {
				// Re-render all the product's
				myDataStore.indexedDB.getAllProducts();
			};

			request.onerror = function(e) {
				console.log(e.value);
			};
		};

		myDataStore.indexedDB.getAllProducts = function() {
		
			var products = document.getElementById('productsList');
			products.innerHTML = '';

			var db = myDataStore.indexedDB.db;
			var trans = db.transaction(['product'], 'readwrite');
			var store = trans.objectStore('product');

			// Get everything in the store;
			var keyRange = IDBKeyRange.lowerBound(0);
			var cursorRequest = store.openCursor(keyRange);

			cursorRequest.onsuccess = function(e) {
				var result = e.target.result;
				if (!!result == false)
					return;

				displayProduct(result.value);
				result.continue();
			};

			cursorRequest.onerror = myDataStore.indexedDB.onerror;
		};

		function displayProduct(prod) {
		
			var products = document.getElementById('productsList');
			var li = document.createElement('li');
			products.appendChild(li);

			var span = document.createElement('span');
			span.setAttribute('class', 'productDescription');
			span.innerHTML = '[' + prod.id + '] ' + prod.name + ', ' + prod.price;
			li.appendChild(span);

			var a = document.createElement('a');
			a.textContent = 'Delete';
			a.setAttribute('href', '#');
			a.addEventListener('click', function(e) {
				myDataStore.indexedDB.deleteProduct(prod.id);
			});
			li.appendChild(a);
		}

		myDataStore.indexedDB.deleteProduct = function(id) {
		
			var db = myDataStore.indexedDB.db;
			var trans = db.transaction(['product'], 'readwrite');
			var store = trans.objectStore('product');

			var request = store.delete(id);

			request.onsuccess = function(e) {
				myDataStore.indexedDB.getAllProducts();	
			};

			request.onerror = function(e) {
				console.log(e);
			};
		};

		function addProduct() {
			var nameElem  = document.getElementById('nameTextBox');
			var priceElem = document.getElementById('priceTextBox');

			myDataStore.indexedDB.addProduct(count++, nameElem.value, priceElem.value);
			nameElem.value = '';
			priceElem.value = '';
		}
		
		function init() {
			myDataStore.indexedDB.open(); 
			document.getElementById('addProductButton').addEventListener('click', addProduct, false);
		}

		window.addEventListener('DOMContentLoaded', init, false);

	</script>
</head>

<body>
	<h1>Products IndexedDB Example</h1>
	
	<label>Product name:</label> <input type='text' id='nameTextBox' /> <br>
	<label>Unit price:</label>   <input type='text' id='priceTextBox' /> <br>
	
	<button id='addProductButton'>Add</button>
	
	<ul id='productsList'></ul> 

</body>
</html>